<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      The difference between Rspec spies, doubles and instance_doubles &middot; Androidgrl's Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0e">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
      <img src="./public/githubphoto.jpeg">Androidgrl</img>
      <p>Hello!  Welcome to androidgrl's blog!  My name is Jamie Kawahara I am a software developer and 3D printing enthusiast.  I hope you find the tutorials helpful.</p>
      <a href="https://twitter.com/androidgrl">Twitter</a></br>
      <a href="https://github.com/androidgrl">Github</a>
  </div>

  <nav class="sidebar-nav">

    

    
    
      
        
      
    
      
        
      
    
      
        
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2019. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Androidgrl's Blog</a>
            <small>About 3D Printing & Tech, by Jamie Kawahara</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">The difference between Rspec spies, doubles and instance_doubles</h1>
  <span class="post-date">13 Jul 2016</span>
  <p>Throughout the code base of our Rails app at work, we have many Rspec tests that use spies, doubles and instance_doubles.  I found most of the information on the web about them to be very theoretical and not practical.  My coworker then explained it to me very clearly as follows:</p>

<ol>
  <li>
    <p>All three terms belong under an umbrella term called “doubles”. In other words, a spy is a type of double, and so is an instance_double.</p>
  </li>
  <li>
    <p>Spies, doubles, and instance_doubles are doubles that increase in their power of specificity in that order. So a double is more specific than a spy and an instance_double is more specific than a double.</p>
  </li>
</ol>

<p>The best way to demonstrate how they work is to pry into an rspec file.  This assumes that you are already familiar with setting up an Rspec test file in a Rails app. In the Rspec file, inside an “it” block place a binding.pry.</p>

<p><code>
    it "demonstrates doubles" do
      binding.pry
    end
</code></p>

<p>In the pry session, define a spy, then try to call undefined methods on it.  It will keep returning a double.  So spies, are just generic doubles that will keep giving you a double no matter what methods you call on them.</p>

<p><code>
pry(#&lt;RSpec&gt;)&gt; s=spy
=&gt; #&lt;Double (anonymous)&gt;
pry(#&lt;RSpec&gt;)&gt; s.what?
=&gt; #&lt;Double (anonymous)&gt;
pry(#&lt;RSpec&gt;)&gt; s.anything?
=&gt; #&lt;Double (anonymous)&gt;
</code></p>

<p>Moving towards more specificity, define a double.  Below a double is defined with a method called name that returns the string “androidgrl”.  When we call name on the double it returns “androidgrl”.  What happens when we call an undefined method like “age” on the double?  It gives us an error unlike with spies.  So with doubles, you have to define methods that can be called on them.</p>

<p><code>
pry(#&lt;RSpec&gt;)&gt; d=double(name: "androidgrl")
=&gt; #&lt;Double (anonymous)&gt;
pry(#&lt;RSpec&gt;)&gt; d.name
=&gt; "androidgrl"
pry(#&lt;RSpec&gt;)&gt; d.age
RSpec::Mocks::MockExpectationError: #&lt;Double (anonymous)&gt; received unexpected message :age with (no args)
from /opt/active/acl_api/current/vendor/bundle/ruby/2.1.0/gems/rspec-support-3.3.0/lib/rspec/support.rb:86:in `block in &lt;module:Support&gt;'
</code></p>

<p>And finally, we have the most specific type of double, instance_doubles.  Here we have to specify which Class we’re defining the double for.  This has to be an actual class that exists either in your application or inherited through Ruby.  Here we’re stubbing out the “count” method on the Array class to always return 3.  Notice that when we try to define a method on Array that doesn’t actually exist we get an error.  Also when we try to make an instance double for a Class that doesn’t exist we get an error.</p>

<p><code>
pry(#&lt;RSpec&gt;)&gt; i=instance_double(Array, count: 3)
=&gt; #&lt;InstanceDouble(Array) (anonymous)&gt;
pry(#&lt;RSpec&gt;)&gt; i.count
=&gt; 3
pry(#&lt;RSpec&gt;)&gt; i=instance_double(Array, whatever: "?")
RSpec::Mocks::MockExpectationError: the Array class does not implement the instance method: whatever
from /opt/active/acl_api/current/vendor/bundle/ruby/2.1.0/gems/rspec-support-3.3.0/lib/rspec/support.rb:86:in `block in &lt;module:Support&gt;'
</code>
<code>
pry(#&lt;RSpeci=instance_double(FakeClass, fake_method: "fake")
NameError: uninitialized constant TM::FakeClass
from (pry):14:in `block (2 levels) in &lt;module:TM&gt;'
</code></p>

<p>In summary:</p>

<ol>
  <li>
    <p>Instance_doubles have to be defined on Classes that actually exist in your code and you can only stub methods that actually exist.</p>
  </li>
  <li>
    <p>Doubles can have any methods called on them as long as you define them in the double.</p>
  </li>
  <li>
    <p>Spies don’t need to have anything defined on them and will always return a double.</p>
  </li>
</ol>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/01/01/binary/">
            How Does a Computer Physically Store Binary Code?
            <small>01 Jan 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/04/14/testing/">
            Determining the Scope of What to Test Inside Methods
            <small>14 Apr 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/02/17/languages/">
            What Makes a Language Fast?  Five Factors That Affect a Programming Language's Speed
            <small>17 Feb 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
